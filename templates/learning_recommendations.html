{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Navigation Bar -->
    <nav class="bg-surface px-4 py-3 flex justify-between items-center">
        <a href="{{ url_for('index') }}" class="text-2xl font-bold text-primary">LearnerID</a>
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('index') }}" class="text-white/70 hover:text-white">Home</a>
            <a href="{{ url_for('learning_history') }}" class="text-white/70 hover:text-white">Learning History</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-xl {% if category == 'success' %}bg-green-500/10 text-green-500{% else %}bg-blue-500/10 text-blue-500{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="mb-8">
            <a href="{{ url_for('my_learning_details', topic=parent_course) }}" 
               class="inline-flex items-center text-white/70 hover:text-white">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Course Details
            </a>
            <h1 class="text-3xl font-bold text-white mt-4">Your Learning Resources</h1>
            <p class="text-white/70 mt-2">Week {{ week_number }}: {{ topic }}</p>
        </div>

        <!-- Topic Container -->
        <div class="bg-surface rounded-2xl p-6 border border-white/10 mb-8">
            <!-- Topic Header -->
            <div class="mb-8">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white">{{ topic }}</h2>
                        {% if topic_info %}
                        <p class="text-white/70 mt-1">Progress: {{ topic_info.progress }}%</p>
                        {% endif %}
                    </div>
                    <form onsubmit="handleTopicCompletion(event, '{{ topic }}')" class="flex-shrink-0">
                        <button type="submit" 
                                class="px-4 py-2 rounded-xl {% if topic_info and topic_info.completed %}bg-green-500/20 text-green-500{% else %}bg-white/5 text-white/70{% endif %} hover:bg-white/10">
                            {% if topic_info and topic_info.completed %}
                                <i class="fas fa-check mr-2"></i>Topic Completed
                            {% else %}
                                Mark Topic as Complete
                            {% endif %}
                        </button>
                    </form>
                </div>

                <!-- Quiz Section -->
                <div class="bg-surface/30 rounded-xl p-6 mb-8">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-white mb-3">Knowledge Assessment</h3>
                            <p class="text-white/70 text-lg mb-4">Test your understanding of {{ topic }}</p>
                        </div>
                        {% if not topic_info or not topic_info.completed %}
                            <a href="{{ url_for('show_topic_quiz', topic=topic) }}"
                               class="inline-flex items-center px-6 py-3 rounded-xl bg-primary hover:bg-primary/90 text-white font-medium transition-colors">
                                <i class="fas fa-book-reader mr-2"></i>
                                Start Assessment
                            </a>
                        {% endif %}
                    </div>

                    {% if quiz_stats %}
                    <div class="grid grid-cols-3 gap-6 mt-6">
                        <div class="bg-surface/50 p-4 rounded-xl text-center">
                            <p class="text-sm font-medium text-white/70 mb-1">Attempts Made</p>
                            <p class="text-2xl font-semibold text-white">{{ quiz_stats.attempts_made }}</p>
                        </div>
                        <div class="bg-surface/50 p-4 rounded-xl text-center">
                            <p class="text-sm font-medium text-white/70 mb-1">Average Score</p>
                            <p class="text-2xl font-semibold text-white">{{ "%.1f"|format(quiz_stats.avg_score) }}%</p>
                        </div>
                        <div class="bg-surface/50 p-4 rounded-xl text-center">
                            <p class="text-sm font-medium text-white/70 mb-1">Attempts Left</p>
                            <p class="text-2xl font-semibold text-white">{{ quiz_stats.attempts_left }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Learning Resources -->
            {% if recommendations.videos %}
            <div class="space-y-8">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-video mr-3 text-primary"></i>
                    Video Resources
                </h3>
                {% for video in recommendations.videos %}
                <div class="bg-white/5 hover:bg-white/10 rounded-xl p-6 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-lg font-medium text-white">{{ video.title }}</h4>
                            <p class="text-white/70 mt-2 mb-4">{{ video.description }}</p>
                            <div class="flex items-center">
                                <span class="text-white/50"><i class="fas fa-clock mr-2"></i>{{ video.duration }}</span>
                                <a href="{{ video.url }}" target="_blank" 
                                   class="ml-6 text-primary hover:text-primary/90 inline-flex items-center">
                                   <i class="fas fa-play-circle mr-2"></i>Watch Video
                                </a>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 ml-6">
                            <form onsubmit="handleResourceCompletion(event, '{{ topic }}', '{{ video.id }}')" class="flex-shrink-0">
                                <button type="submit" 
                                        class="inline-flex items-center px-4 py-2 rounded-xl {% if video.completed %}bg-green-500/20 text-green-500{% else %}bg-white/5 text-white/70{% endif %} hover:bg-white/10 transition-colors">
                                    <i class="fas {% if video.completed %}fa-check{% else %}fa-check-circle{% endif %} mr-2"></i>
                                    {% if video.completed %}Completed{% else %}Mark Complete{% endif %}
                                </button>
                            </form>
                            {% if video.credits_unlocked %}
                                <span class="inline-flex items-center px-4 py-2 rounded-xl bg-green-500/20 text-green-500">
                                    <i class="fas fa-star mr-2"></i>Credits Unlocked
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Reading Materials -->
            {% if recommendations.articles %}
            <div class="space-y-8 mt-12">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-book mr-3 text-primary"></i>
                    Reading Materials
                </h3>
                {% for article in recommendations.articles %}
                <div class="bg-white/5 hover:bg-white/10 rounded-xl p-6 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-lg font-medium text-white">{{ article.title }}</h4>
                            <p class="text-white/70 mt-2 mb-4">{{ article.description }}</p>
                            <div class="flex items-center">
                                <span class="text-white/50">
                                    <i class="fas fa-clock mr-2"></i>{{ article.reading_time }}
                                </span>
                                <a href="{{ article.url }}" target="_blank" 
                                   class="ml-6 text-primary hover:text-primary/90 inline-flex items-center">
                                   <i class="fas fa-book-open mr-2"></i>Read Article
                                </a>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 ml-6">
                            <form onsubmit="handleResourceCompletion(event, '{{ topic }}', '{{ article.id }}')" class="flex-shrink-0">
                                <button type="submit" 
                                        class="inline-flex items-center px-4 py-2 rounded-xl {% if article.completed %}bg-green-500/20 text-green-500{% else %}bg-white/5 text-white/70{% endif %} hover:bg-white/10 transition-colors">
                                    <i class="fas {% if article.completed %}fa-check{% else %}fa-check-circle{% endif %} mr-2"></i>
                                    {% if article.completed %}Completed{% else %}Mark Complete{% endif %}
                                </button>
                            </form>
                            {% if article.credits_unlocked %}
                                <span class="inline-flex items-center px-4 py-2 rounded-xl bg-green-500/20 text-green-500">
                                    <i class="fas fa-star mr-2"></i>Credits Unlocked
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Research Papers -->
            {% if recommendations.papers %}
            <div class="space-y-8 mt-12">
                <h3 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-file-alt mr-3 text-primary"></i>
                    Research Papers
                </h3>
                {% for paper in recommendations.papers %}
                <div class="bg-white/5 hover:bg-white/10 rounded-xl p-6 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-lg font-medium text-white">{{ paper.title }}</h4>
                            <p class="text-white/70 mt-2">{{ paper.authors }}</p>
                            <p class="text-white/70 mt-2 mb-4">{{ paper.abstract }}</p>
                            <div class="flex items-center">
                                <span class="text-white/50">
                                    <i class="fas fa-calendar mr-2"></i>Published: {{ paper.published_date }}
                                </span>
                                <a href="{{ paper.url }}" target="_blank" 
                                   class="ml-6 text-primary hover:text-primary/90 inline-flex items-center">
                                   <i class="fas fa-external-link-alt mr-2"></i>Read Paper
                                </a>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 ml-6">
                            <form onsubmit="handleResourceCompletion(event, '{{ topic }}', '{{ paper.id }}')" class="flex-shrink-0">
                                <button type="submit" 
                                        class="inline-flex items-center px-4 py-2 rounded-xl {% if paper.completed %}bg-green-500/20 text-green-500{% else %}bg-white/5 text-white/70{% endif %} hover:bg-white/10 transition-colors">
                                    <i class="fas {% if paper.completed %}fa-check{% else %}fa-check-circle{% endif %} mr-2"></i>
                                    {% if paper.completed %}Completed{% else %}Mark Complete{% endif %}
                                </button>
                            </form>
                            {% if paper.credits_unlocked %}
                                <span class="inline-flex items-center px-4 py-2 rounded-xl bg-green-500/20 text-green-500">
                                    <i class="fas fa-star mr-2"></i>Credits Unlocked
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- User Materials -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-medium text-white">Your Learning Materials</h3>
                    <button onclick="toggleAddMaterialForm()"
                            class="px-4 py-2 bg-primary hover:bg-primary/90 rounded-xl text-white transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Material
                    </button>
                </div>

                <!-- Add Material Form -->
                <div id="addMaterialForm" class="hidden mb-6 bg-white/5 p-6 rounded-xl">
                    <form action="{{ url_for('add_learning_material', topic=topic) }}" method="POST" enctype="multipart/form-data" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Material Type</label>
                            <select name="material_type" onchange="toggleMaterialInput(this.value)" 
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-xl text-white">
                                <option value="document">Document (PDF/Word)</option>
                                <option value="video">Video URL</option>
                                <option value="article">Article URL</option>
                            </select>
                        </div>

                        <div id="documentInput">
                            <label class="block text-sm font-medium text-white mb-2">Upload Document</label>
                            <input type="file" name="document" accept=".pdf,.doc,.docx"
                                   class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-xl text-white">
                        </div>

                        <div id="urlInput" class="hidden">
                            <label class="block text-sm font-medium text-white mb-2">URL</label>
                            <input type="url" name="url" placeholder="https://example.com"
                                   class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/40">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Title</label>
                            <input type="text" name="title" required
                                   class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/40"
                                   placeholder="Enter a title for this material">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-white mb-2">Description</label>
                            <textarea name="description" rows="3" 
                                    class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/40"
                                    placeholder="Add a brief description"></textarea>
                        </div>

                        <button type="submit" 
                                class="w-full px-4 py-2 bg-primary hover:bg-primary/90 rounded-xl text-white transition-colors">
                            Save Material
                        </button>
                    </form>
                </div>

                <!-- User Materials List -->
                <div class="space-y-4">
                    {% for material in user_materials %}
                    <div class="flex items-start justify-between p-4 bg-white/5 rounded-xl">
                        <div class="flex-1">
                            <h4 class="text-white font-medium">{{ material.title }}</h4>
                            <p class="text-white/70 text-sm mt-1">{{ material.description }}</p>
                            <div class="flex items-center mt-2">
                                <span class="text-white/50 text-sm">Type: {{ material.type }}</span>
                                {% if material.type == 'document' %}
                                    <a href="{{ url_for('download_material', material_id=material.id) }}" 
                                       class="ml-4 text-primary hover:text-primary/90">Download</a>
                                {% else %}
                                    <a href="{{ material.url }}" target="_blank" 
                                       class="ml-4 text-primary hover:text-primary/90">Open Link</a>
                                {% endif %}
                            </div>
                        </div>
                        <form action="{{ url_for('delete_material', material_id=material.id) }}" method="POST"
                              onsubmit="return confirm('Are you sure you want to delete this material?')">
                            <button type="submit" class="text-red-500 hover:text-red-400">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function toggleAddMaterialForm() {
    const form = document.getElementById('addMaterialForm');
    form.classList.toggle('hidden');
}

function toggleMaterialInput(type) {
    const documentInput = document.getElementById('documentInput');
    const urlInput = document.getElementById('urlInput');
    
    if (type === 'document') {
        documentInput.classList.remove('hidden');
        urlInput.classList.add('hidden');
    } else {
        documentInput.classList.add('hidden');
        urlInput.classList.remove('hidden');
    }
}

function handleTopicCompletion(event, topic) {
    event.preventDefault();
    
    fetch(`/mark-topic-completed/${encodeURIComponent(topic)}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.reload();
        } else {
            console.error('Error:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function handleResourceCompletion(event, topic, resourceId) {
    event.preventDefault();
    
    fetch(`/mark-resource-completed/${encodeURIComponent(topic)}/${resourceId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.reload();
        } else {
            console.error('Error:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}